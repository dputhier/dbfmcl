```{r , include = FALSE}
# Load libraries
suppressWarnings(suppressMessages(library(Seurat, quietly = TRUE)))
suppressWarnings(suppressMessages(library(scigenex, quietly = TRUE)))

#Create Seurat object
pbmc <- Read10X(data.dir = "/mnt/NAS7/Workspace/bavaisj/dbfmcl/dataset_pbmc/filtered_gene_bc_matrices/hg19/")
suppressWarnings(pbmc_seurat <- CreateSeuratObject(counts = pbmc, project = "pbmc3k",
                                                   min.cells = 3, 
                                                   min.features = 200))

# Quality control
pbmc_seurat[["percent.mt"]] <- PercentageFeatureSet(pbmc_seurat, pattern = "^MT-")
pbmc_seurat <- subset(pbmc_seurat, subset = percent.mt < 5 & nFeature_RNA > 200)

# Normalizing
pbmc_seurat <- NormalizeData(pbmc_seurat)

# Identification of highly variable genes
pbmc_seurat <- FindVariableFeatures(pbmc_seurat, selection.method = "vst", nfeatures = 2000)

# Scaling data
pbmc_seurat <- ScaleData(pbmc_seurat, features = rownames(pbmc_seurat), verbose = FALSE)

# Perform principal component analysis
pbmc_seurat <- RunPCA(pbmc_seurat, features = VariableFeatures(object = pbmc_seurat), verbose = FALSE)

# Cell clustering 
pbmc_seurat <- FindNeighbors(pbmc_seurat, dims = 1:10, verbose = FALSE)
pbmc_seurat <- FindClusters(pbmc_seurat, resolution = 0.5, verbose = FALSE)

# Dimension reduction
pbmc_seurat <-suppressWarnings(RunUMAP(pbmc_seurat, dims = 1:10, verbose = FALSE))

# Run DBFMCL
pbmc_scigenex <- DBFMCL(data = pbmc_seurat,
                        k = 80,
                        inflation = 2,
                        min_cluster_size = 5,
                        av_dot_prod_min = 2)
pbmc_scigenex <- top_genes(pbmc_scigenex, top = 10)
pbmc_scigenex@top_genes
```


# Alternative cell clustering method using DynamicTreeCut
We also provide an alternative way to cluster cells based on hierarchical clustering. The tree is cut using the DynamicTreeCut R package.
<br>

## Cell clustering
```{r , eval=F}
# Perform hierarchical cluster algorithm and cut the tree using DynamicTreeCut package
pbmc_scigenex <- cell_clust(pbmc_scigenex, min_cluster_size = 4)
```

```{r , eval=T, echo=F}
# Perform hierarchical cluster algorithm and cut the tree using DynamicTreeCut package
pbmc_scigenex <- cell_clust(pbmc_scigenex, min_cluster_size = 4)
```
<br>

## Heatmap visualization
You can visualize your clustering result with the plot_heatmap function using all the cells... ...or the core cells of each cluster provided by DynamicTreeCut.
```{r , eval=T, echo=T}
# Heatmap of the top genes for each pattern of co-expressed genes
plot_heatmap(pbmc_scigenex,
             use_top_genes = TRUE,
             cell_order = names(sort(pbmc_scigenex@cell_clusters$labels)),
             line_size = 2)
```
<br>
...or the core cells of each cluster provided by DynamicTreeCut.
```{r , eval=T, echo=T}
# Using core cells of each cell clusters
plot_heatmap(pbmc_scigenex,
             use_top_genes = TRUE,
             use_core_cells = TRUE,
             line_size = 2)
```
<br>

## Mapping cluster on UMAP
```{r , eval=F}
# ＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿
# Add SciGeneX result on Seurat object
# ‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾
# Add SciGeneX clustering result in metadata of Seurat object
pbmc_seurat[["scigenex_cell_clusters"]] <- pbmc_scigenex@cell_clusters$labels

# Use genes found by SciGeneX as feature selection results
pbmc_seurat@assays$RNA@var.features <- get_genes(pbmc_scigenex)


# ＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿
# Run the classical pipeline of Seurat
# ‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾
# Scaling data
pbmc_seurat <- ScaleData(pbmc_seurat,
                         features = rownames(pbmc_seurat))

# Perform principal component analysis
pbmc_seurat <- RunPCA(pbmc_seurat,
                      features = VariableFeatures(object = pbmc_seurat))

# Cell clustering 
pbmc_seurat <- FindNeighbors(pbmc_seurat, dims = 1:10)
pbmc_seurat <- FindClusters(pbmc_seurat, resolution = 0.5)

# Dimension reduction
pbmc_seurat <- RunUMAP(pbmc_seurat, dims = 1:10)

# Map SciGeneX cell clustering results on UMAP
col_rainbow = c("#E96767", "#EC9342", "#FFCA3A", "#8AC926", "#4DADE8",
                "#9579B9", "#E25CB4", "#EF9292", "#7BC4EE", "#F2B57D", 
                "#FFDA77", "#B6E36A", "#9F1717", "#517416", "#9F1717",
                "#AE5B11")
DimPlot(pbmc_seurat, reduction = "umap", group.by = "scigenex_cell_clusters",
        cols = col_rainbow)
```


```{r , eval=T, echo=F}
# Add SciGeneX clustering result in metadata of Seurat object
pbmc_seurat[["scigenex_cell_clusters"]] <- pbmc_scigenex@cell_clusters$labels

# Identification of highly variable genes
pbmc_seurat@assays$RNA@var.features <- get_genes(pbmc_scigenex)

# Scaling data
pbmc_seurat <- ScaleData(pbmc_seurat, features = rownames(pbmc_seurat), verbose = FALSE)

# Perform principal component analysis
pbmc_seurat <- RunPCA(pbmc_seurat, features = VariableFeatures(object = pbmc_seurat), verbose = FALSE)

# Cell clustering 
pbmc_seurat <- FindNeighbors(pbmc_seurat, dims = 1:10, verbose = FALSE)
pbmc_seurat <- FindClusters(pbmc_seurat, resolution = 0.5, verbose = FALSE)

# Dimension reduction
pbmc_seurat <-suppressWarnings(RunUMAP(pbmc_seurat, dims = 1:10, verbose = FALSE))

# Map SciGeneX cell clustering results on UMAP
col_rainbow = c("#E96767", "#EC9342", "#FFCA3A", "#8AC926", "#4DADE8",
                "#9579B9", "#E25CB4", "#EF9292", "#7BC4EE", "#F2B57D", 
                "#FFDA77", "#B6E36A", "#9F1717", "#517416", "#9F1717",
                "#AE5B11")
DimPlot(pbmc_seurat, reduction = "umap", group.by = "scigenex_cell_clusters",
        cols = col_rainbow)
```




<!-- ## Gene cluster enrichment analysis -->
<!-- ```{r , eval=F} -->
<!-- # Enrichment analysis -->
<!-- pbmc_scigenex <- enrich_go(pbmc_scigenex, specie = "Hsapiens", ontology = "BP") -->
<!-- pbmc_scigenex <- viz_enrich(pbmc_scigenex, type = "barplot", nb_terms = 5) -->
<!-- pbmc_scigenex@cluster_annotations$plot_cl5$barplot -->
<!-- ``` -->

<!-- ```{r , eval=T, echo=F} -->
<!-- # Enrichment analysis -->
<!-- pbmc_scigenex@cluster_annotations$plot_cl6$barplot -->
<!-- ``` -->
<!-- <br> -->
<!-- <br> -->

<!-- ## Example of identification of rare cell population -->
<!-- ```{r , eval=T, echo=T} -->
<!-- # Visualization of a co-expressed gene pattern expressed in a small number of genes -->
<!-- plot_heatmap(pbmc_scigenex, -->
<!--              use_top_genes = TRUE, -->
<!--              use_core_cells = TRUE, -->
<!--              line_size = 2, -->
<!--              cluster = 7) -->

<!-- # In the top genes of the pattern, we identify genes that are known to be marker of plasmacytoid dendritic cells (LILRA4, CLEC4C, SERPINF1) -->
<!-- get_genes(pbmc_scigenex, cluster = 7, top = TRUE) -->


<!-- # Mapping the cell cluster on UMAP -->
<!-- ## Use genes selected by SciGeneX as feature selection -->

<!-- ## Scaling data -->
<!-- pbmc_seurat <- ScaleData(pbmc_seurat, features = rownames(pbmc_seurat)) -->
<!-- ## Principal component analysis -->
<!-- pbmc_seurat <- RunPCA(pbmc_seurat, features = VariableFeatures(object = pbmc_seurat)) -->
<!-- ## Dimension reduction -->
<!-- pbmc_seurat <- RunUMAP(pbmc_seurat, dims = 1:10) -->


<!-- DimPlot(pbmc_seurat, reduction = "umap", cells.highlight = get_cells(pbmc_scigenex, cluster = 13)) -->

<!-- ``` -->








